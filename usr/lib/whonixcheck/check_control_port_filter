#!/bin/bash

## This file is part of Whonix.
## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>
## See the file COPYING for copying conditions.

check_control_port_filter_running() {
   trap "error_handler" ERR

   ## {{ Small check if Control Port Filter Proxy is functional.

   ## Only testing on Whonix-Gateway, because Control Port Filter Proxy only
   ## runs on Whonix-Gateway.
   local i
   i="0"
   if [ "$VM" = "Whonix-Gateway" ]; then
      while [ ! -f "/var/run/controlportfilt/ownrunning" ]; do
         i="$(( $i + 1 ))"
         if [ "$i" -ge "30" ]; then
            break
         fi
         sleep "1" &
         lastpid="$!"
         wait "$lastpid" || true
      done
      if [ ! -f "/var/run/controlportfilt/ownrunning" ]; then
         local MSG="<p>Control Port Filter Proxy Test Result:
<b>File /var/run/controlportfilt/ownrunning does not exist.</b> Please report this Whonix bug!<\p>"
         if [ "$started_tor_bootstrap_progress_bar" = "1" ]; then
            $output ${output_opts[@]} --progressbaridx "$progressbaridx" --progressx "100"
         fi
         $output ${output_opts[@]} --messagex --typex "error" --titlex "$TITLE" --message "$MSG"
         $output ${output_opts[@]} --messagecli --typecli "error" --titlecli "$TITLE" --message "$MSG"
         EXIT_CODE="1"
         cleanup "1"
         return 0
      else
         local MSG="<p>Control Port Filter Proxy Test Result: OK</p>"
         if [ "$verbose" = "1" ]; then
            $output ${output_opts[@]} --messagex --typex "info" --titlex "$TITLE" --message "$MSG"
            $output ${output_opts[@]} --messagecli --typecli "info" --titlecli "$TITLE" --message "$MSG"
         fi
      fi
   fi

   ## }}
}
